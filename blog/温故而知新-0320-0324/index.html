<!doctype html>
<html lang="en-us">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title> 温故而知新-0320-0324 - RainPot Blog </title>
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="320">
    <meta name="referrer" content="no-referrer">
    <meta name="description" content="温故而知新" />
    <meta property="og:site_name" content="RainPot Blog" />
    <meta property="og:locale" content="en_US" />
    <meta property="og:type" content="article" />
    <meta property="og:url" content="/blog/%E6%B8%A9%E6%95%85%E8%80%8C%E7%9F%A5%E6%96%B0-0320-0324/" />
    <meta property="og:title" content="温故而知新-0320-0324" />
    <meta property="og:image" content="/" />
    <meta property="og:description" content="温故而知新" />
    <meta name="twitter:card" content="summary_large_image" />
    
    <meta name="twitter:title" content="温故而知新-0320-0324" />
    <meta name="twitter:description" content="温故而知新" />
    

    <meta name="twitter:image" content="/" />
    <link rel="canonical" href="/blog/%E6%B8%A9%E6%95%85%E8%80%8C%E7%9F%A5%E6%96%B0-0320-0324/">
    
    <link rel="stylesheet" href="/css/site.min.css" />
    <link rel="stylesheet" href="/css/custom.css" />

    
    
    <link href="/index.xml" rel="alternate" type="application/rss+xml" title="RainPot Blog" />
    
  </head>

  <body>
    
<div class="mt-xl header">
  <header>
    <div class="container">
      <div class="row justify-content-center">
	<div class="col-auto">
	  <a href="/" style="display: contents">
	    <h1 class="name text-center">RainPot Blog</h1>
	  </a>
	</div>
      </div>
      <div class="row justify-content-center">
	<section class="nav  justify-content-center">
	  <ul>
	    
	    <li class="nav-item justify-content-center mx-auto"> 
	      <a class="nav-link" href="/">
		
		Home
	      </a>
	    </li>
	    
	    <li class="nav-item justify-content-center mx-auto"> 
	      <a class="nav-link" href="/blog/">
		
		Articles
	      </a>
	    </li>
	    
	    <li class="nav-item justify-content-center mx-auto"> 
	      <a class="nav-link" href="/reflection/">
		
		Reflection
	      </a>
	    </li>
	    
	    <li class="nav-item justify-content-center mx-auto"> 
	      <a class="nav-link" href="/about">
		
		About
	      </a>
	    </li>
	    
	    <li class="nav-item justify-content-center mx-auto"> 
	      <a class="nav-link" href="https://github.com/RainPot">
		
		Subscribe
	      </a>
	    </li>
	    
	    
	  </ul>
	</section>
      </div>
    </div>
  </header>
</div>

<div class="content">
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-sm-12 col-lg-8">
	<h1 class="mx-0 mx-md-4 blog-post-title">温故而知新-0320-0324</h1>
	<div class="meta-data meta">
	  
	  
	  
	  <span class="author meta-data" title="Cynicsss">
	    Cynicsss
	  </span>
	  
	  
	  <span class="date middot meta-data" title='Sat Mar 25 2023 00:00:00 UTC'>
	    2023-03-25
	  </span>
	  <span class="reading-time middot meta-data">
	    3 min read
	  </span>
	  
	  <a class="middot meta-data" href="/blog/%E6%B8%A9%E6%95%85%E8%80%8C%E7%9F%A5%E6%96%B0-0320-0324/">Permalink</a>
	  <div class="d-none d-md-inline tags">
	    <ul class="list-unstyled d-inline">
	      
	    </ul>
	  </div>
	</div>
	<div class="markdown blog-post-content">
	  <h3 id="0一些感悟">0.一些感悟</h3>
<p>对于解决问题的能力：</p>
<ol>
<li>首先是对于需求方提出的需求：如果遇到 <code>技术上较难解决 / 成本较高</code> 的需求时，难免会陷入内耗拒绝抱怨的心态，而此时更难得的是保持一颗解决问题的心，要主动去思考为什么没人解决、可以通过什么方式去解决，快速高效地去实现出来。</li>
<li>其次是主动发现需求点的能力：要主动跟需求方沟通，了解他们的工作模式方式，可能会存在一些可以主动提效的点，针对这些点去改进。</li>
<li>较大型的项目/需求：leader强调过，要把自己当作一个合格的产品+开发+测试，需求分析、可行性分析、方案设计、开发测试、上线维护都要考虑到，且每一步都应尽可能得完善。</li>
</ol>
<hr>
<h3 id="1rn原生桥-ios-获取-jscontext">1.RN原生桥 iOS 获取 JSContext</h3>
<ul>
<li>你可以通过 RCTBridgeDelegate 协议的 sourceURLForBridge: 方法来获取 RN 加载的 JS 代码的 URL。</li>
<li>你可以通过 RCTBridge 的 executeSourceCode: 方法来执行 JS 代码，并返回一个 JSContext 实例。</li>
<li>你可以通过 RCTJavaScriptExecutor 协议的 executeBlockOnJavaScriptQueue: 方法来在 JS 线程上执行一个 Block，并在 Block 中访问 JSContext 实例。</li>
<li>你可以通过 JSContext 的 setObject:forKeyedSubscript: 方法来向 JS 环境中注入原生对象或函数。</li>
</ul>
<p>在 React Native 中，如果您需要在原生代码中获取当前的 JavaScript 上下文（JSContext），可以通过 <code>RCTBridge</code> 类的 <code>currentBridge</code> 方法来实现。 <code>RCTBridge</code> 类是 React Native 框架中的一个核心类，它负责管理 JavaScript 和原生代码之间的通信，并提供了一些方法和属性来处理这种通信。</p>
<p>您可以使用以下代码获取当前的 JSContext：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-objc" data-lang="objc"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#import &lt;React/RCTBridge.h&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#import &lt;JavaScriptCore/JavaScriptCore.h&gt;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// ...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#000">RCTBridge</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bridge</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">RCTBridge</span> <span style="color:#000">currentBridge</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span><span style="color:#000">JSContext</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">jsContext</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">bridge</span> <span style="color:#f57900">valueForKey</span><span style="color:#000;font-weight:bold">:</span><span style="color:#4e9a06">@&#34;jsExecutor&#34;</span><span style="color:#000;font-weight:bold">].</span><span style="color:#000">context</span><span style="color:#000;font-weight:bold">;</span>
</span></span></code></pre></div><p>在上述代码中，我们首先获取当前的 <code>RCTBridge</code> 实例，然后通过 <code>valueForKey:</code> 方法获取到 <code>jsExecutor</code> 属性。<code>jsExecutor</code> 属性是 <code>RCTCxxBridge</code> 类的一个实例，该类是 <code>RCTBridge</code> 的一个子类。最后，我们使用 <code>context</code> 属性获取当前的 JSContext。</p>
<p>如何通过JSContext拿到当前RN的Bundle信息？</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-objc" data-lang="objc"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 获取 __fbBatchedBridgeConfig 这个全局变量的 JSValue 实例
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">JSValue</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">config</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">jsContext</span> <span style="color:#f57900">objectForKeyedSubscript</span><span style="color:#000;font-weight:bold">:</span><span style="color:#4e9a06">@&#34;__fbBatchedBridgeConfig&#34;</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 获取 bundleURL 这个属性的 JSValue 实例
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">JSValue</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">bundleURL</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">config</span> <span style="color:#f57900">objectForKeyedSubscript</span><span style="color:#000;font-weight:bold">:</span><span style="color:#4e9a06">@&#34;bundleURL&#34;</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 将 JSValue 转换为 NSString 类型
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">NSString</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">urlString</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">bundleURL</span> <span style="color:#000">toString</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 打印结果
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">NSLog</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">@&#34;The bundle URL is: %@&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">urlString</span><span style="color:#000;font-weight:bold">);</span>
</span></span></code></pre></div><p>具体的hook 实现：
在iOS Native Module中，可以使用<code>RCTJavaScriptContext</code>类来获取当前的JSContext。以下是一个示例，演示了如何在Objective-C中获取当前的JSContext：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-objc" data-lang="objc"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#import &#34;React/RCTBridgeModule.h&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">#import &#34;React/RCTJavaScriptContext.h&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@interface</span> <span style="color:#000">MyNativeModule</span> : <span style="color:#000">NSObject</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">RCTBridgeModule</span><span style="color:#ce5c00;font-weight:bold">&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@end</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@implementation</span> <span style="color:#000">MyNativeModule</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">RCT_EXPORT_MODULE</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">RCT_EXPORT_METHOD</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">doSomething</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">RCTJavaScriptContext</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">context</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#204a87">self</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">bridge</span> <span style="color:#f57900">valueForKey</span><span style="color:#000;font-weight:bold">:</span><span style="color:#4e9a06">@&#34;javaScriptContext&#34;</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">JSContext</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">jsContext</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">context</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">JSGlobalContextRef</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#8f5902;font-style:italic">// Do something with jsContext...
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">@end</span>
</span></span></code></pre></div><p>以下是一个用于 Hook <code>RCT_EXPORT_METHOD</code> 的例子，把原有的 <code>print:</code> 方法改成输出 <code>%@ Hooked</code> 的文本：</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-objc" data-lang="objc"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 定义自己的方法（与要 Hook 的方法具有相同的签名）
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">-</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">my_print:</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">NSString</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">param</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">NSLog</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">@&#34;My custom method with param: %@ Hooked&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">param</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 在类的 +load 方法中 Hook RCT_EXPORT_METHOD 宏生成的方法
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000;font-weight:bold">+</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">load</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 获取 RCT_EXPORT_METHOD 生成的方法原有的实现和签名
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">Method</span> <span style="color:#000">originalMethod</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">class_getInstanceMethod</span><span style="color:#000;font-weight:bold">([</span><span style="color:#204a87">self</span> <span style="color:#204a87;font-weight:bold">class</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#204a87;font-weight:bold">@selector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f57900">print</span><span style="color:#000;font-weight:bold">:));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">NSString</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">typeEncoding</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">NSString</span> <span style="color:#f57900">stringWithUTF8String</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">method_getTypeEncoding</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">originalMethod</span><span style="color:#000;font-weight:bold">)];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// 安装自己的实现
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">IMP</span> <span style="color:#000">myIMP</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">imp_implementationWithBlock</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">^</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">id</span> <span style="color:#204a87">self</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">NSString</span> <span style="color:#ce5c00;font-weight:bold">*</span><span style="color:#000">param</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000;font-weight:bold">[</span><span style="color:#204a87">self</span> <span style="color:#f57900">my_print</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">param</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">class_replaceMethod</span><span style="color:#000;font-weight:bold">([</span><span style="color:#204a87">self</span> <span style="color:#204a87;font-weight:bold">class</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#204a87;font-weight:bold">@selector</span><span style="color:#000;font-weight:bold">(</span><span style="color:#f57900">print</span><span style="color:#000;font-weight:bold">:),</span> <span style="color:#000">myIMP</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">typeEncoding</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">UTF8String</span><span style="color:#000;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><hr>
<h3 id="2图像拼接模板匹配算法实现">2.图像拼接模板匹配算法实现</h3>
<p>图像拼接模板匹配算法是一种利用模板在目标图像上滑动，计算相似度，找到最佳匹配位置的方法。这种方法可以用于多个图像的拼接，但需要注意旋转和缩放等因素的影响</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 导入opencv库</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">cv2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 读取两张需要拼接的图片</span>
</span></span><span style="display:flex;"><span><span style="color:#000">img1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cv2</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">imread</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;img1.png&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">img2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cv2</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">imread</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;img2.png&#34;</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 选择一张图片作为模板，另一张作为目标</span>
</span></span><span style="display:flex;"><span><span style="color:#000">template</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">img1</span>
</span></span><span style="display:flex;"><span><span style="color:#000">target</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">img2</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 获取模板的宽度和高度</span>
</span></span><span style="display:flex;"><span><span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">h</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">template</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">shape</span><span style="color:#000;font-weight:bold">[:</span><span style="color:#0000cf;font-weight:bold">2</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 使用cv.matchTemplate()函数进行模板匹配，返回一个匹配结果矩阵</span>
</span></span><span style="display:flex;"><span><span style="color:#000">result</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cv2</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">matchTemplate</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">target</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">template</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">cv2</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">TM_CCOEFF_NORMED</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 获取匹配结果矩阵中的最大值和最小值及其位置</span>
</span></span><span style="display:flex;"><span><span style="color:#000">min_val</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">max_val</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">min_loc</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">max_loc</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">cv2</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">minMaxLoc</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">result</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 根据最大值位置确定模板在目标图像中的位置，计算出拼接后的宽度和高度</span>
</span></span><span style="display:flex;"><span><span style="color:#000">top_left</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">max_loc</span> <span style="color:#8f5902;font-style:italic"># 模板左上角在目标图像中的位置</span>
</span></span><span style="display:flex;"><span><span style="color:#000">bottom_right</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#000">top_left</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">w</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">top_left</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">+</span> <span style="color:#000">h</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#8f5902;font-style:italic"># 模板右下角在目标图像中的位置</span>
</span></span><span style="display:flex;"><span><span style="color:#000">width</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bottom_right</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">target</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">shape</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">])</span> <span style="color:#8f5902;font-style:italic"># 拼接后的宽度为两张图像宽度的最大值</span>
</span></span><span style="display:flex;"><span><span style="color:#000">height</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87">max</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">bottom_right</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">target</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">shape</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">])</span> <span style="color:#8f5902;font-style:italic"># 拼接后的高度为两张图像高度的最大值</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 创建一个空白图像，用于存放拼接后的图像</span>
</span></span><span style="display:flex;"><span><span style="color:#000">result_img</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">np</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">zeros</span><span style="color:#000;font-weight:bold">((</span><span style="color:#000">height</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">width</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">3</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">dtype</span><span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#000">np</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">uint8</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 将两张图像按照位置复制到空白图像上，注意避免重叠区域覆盖</span>
</span></span><span style="display:flex;"><span><span style="color:#000">result_img</span><span style="color:#000;font-weight:bold">[:</span><span style="color:#000">target</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">shape</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000;font-weight:bold">:</span><span style="color:#000">target</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">shape</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">target</span> <span style="color:#8f5902;font-style:italic"># 复制目标图像到左上角</span>
</span></span><span style="display:flex;"><span><span style="color:#000">result_img</span><span style="color:#000;font-weight:bold">[</span><span style="color:#000">top_left</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">]:</span><span style="color:#000">bottom_right</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#000;font-weight:bold">],</span> <span style="color:#000">top_left</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]:</span><span style="color:#000">bottom_right</span><span style="color:#000;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#000;font-weight:bold">]]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">template</span> <span style="color:#8f5902;font-style:italic"># 复制模板图像到匹配位置</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"># 保存拼接后的图片</span>
</span></span><span style="display:flex;"><span><span style="color:#000">cv2</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">imwrite</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;result_img.png&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">result_img</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><hr>
<h3 id="3同时只能存在一个定时器的单例实现">3.同时只能存在一个定时器的单例实现</h3>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-objc" data-lang="objc"><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000;font-weight:bold">@</span><span style="color:#000">implementation</span><span style="color:#ce5c00;font-weight:bold">**</span> <span style="color:#000">videoTimerManager</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 单例实现方法
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">+</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#204a87;font-weight:bold">instancetype</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">shareInstance</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a40000"> </span> <span style="color:#a40000"> </span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#204a87;font-weight:bold">static</span><span style="color:#ce5c00;font-weight:bold">**</span> <span style="color:#000">videoTimerManager</span><span style="color:#ce5c00;font-weight:bold">*</span> <span style="color:#000">_instance</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#204a87">nil</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a40000"> </span> <span style="color:#a40000"> </span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#204a87;font-weight:bold">static</span><span style="color:#ce5c00;font-weight:bold">**</span> <span style="color:#000">dispatch_once_t</span> <span style="color:#000">onceToken</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a40000"> </span> <span style="color:#a40000"> </span> <span style="color:#000">dispatch_once</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">&amp;</span><span style="color:#000">onceToken</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#ce5c00;font-weight:bold">^</span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a40000"> </span> <span style="color:#a40000"> </span> <span style="color:#a40000"> </span> <span style="color:#a40000"> </span> <span style="color:#000">_instance</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[[</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#204a87">self</span><span style="color:#ce5c00;font-weight:bold">**</span> <span style="color:#000">alloc</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000">init</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a40000"> </span> <span style="color:#a40000"> </span> <span style="color:#000;font-weight:bold">});</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a40000"> </span> <span style="color:#a40000"> </span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#204a87;font-weight:bold">return</span><span style="color:#ce5c00;font-weight:bold">**</span> <span style="color:#000">_instance</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 开始定时器
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">startTimer</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a40000"> </span> <span style="color:#a40000"> </span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#204a87;font-weight:bold">if</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#204a87">self</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">timer</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#204a87">self</span><span style="color:#ce5c00;font-weight:bold">**</span> <span style="color:#000">stopTimer</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a40000"> </span> <span style="color:#a40000"> </span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#204a87">self</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">timer</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#000">NSTimer</span> <span style="color:#f57900">scheduledTimerWithTimeInterval</span><span style="color:#000;font-weight:bold">:</span><span style="color:#0000cf;font-weight:bold">1</span> <span style="color:#f57900">target</span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#204a87">self</span><span style="color:#ce5c00;font-weight:bold">**</span> <span style="color:#f57900">selector</span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#204a87;font-weight:bold">@selector</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000;font-weight:bold">(</span><span style="color:#000">timerAction</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#f57900">userInfo</span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#204a87">nil</span><span style="color:#ce5c00;font-weight:bold">**</span> <span style="color:#f57900">repeats</span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#204a87">YES</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a40000"> </span> <span style="color:#a40000"> </span> <span style="color:#000;font-weight:bold">[[</span><span style="color:#000">NSRunLoop</span> <span style="color:#000">mainRunLoop</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#f57900">addTimer</span><span style="color:#000;font-weight:bold">:</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#204a87">self</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">timer</span> <span style="color:#f57900">forMode</span><span style="color:#000;font-weight:bold">:</span><span style="color:#000">NSRunLoopCommonModes</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 停止定时器
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">-</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">stopTimer</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a40000"> </span> <span style="color:#a40000"> </span> <span style="color:#000;font-weight:bold">[</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#204a87">self</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">timer</span> <span style="color:#000">invalidate</span><span style="color:#000;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a40000"> </span> <span style="color:#a40000"> </span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#204a87">self</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">timer</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#204a87">nil</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// 定时器执行的任务
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#204a87;font-weight:bold">void</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000;font-weight:bold">)</span><span style="color:#000">timerAction</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a40000"> </span> <span style="color:#a40000"> </span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#204a87;font-weight:bold">if</span><span style="color:#ce5c00;font-weight:bold">**</span> <span style="color:#000;font-weight:bold">(</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#204a87">self</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">timerBlock</span><span style="color:#000;font-weight:bold">)</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a40000"> </span> <span style="color:#a40000"> </span> <span style="color:#a40000"> </span> <span style="color:#a40000"> </span> <span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#204a87">self</span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#000;font-weight:bold">.</span><span style="color:#000">timerBlock</span><span style="color:#000;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a40000"> </span> <span style="color:#a40000"> </span> <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">**</span><span style="color:#204a87;font-weight:bold">@end</span><span style="color:#ce5c00;font-weight:bold">**</span>
</span></span></code></pre></div><hr>
<h3 id="4chatgpt相关">4.chatgpt相关</h3>
<blockquote>
<p>apikey的生成：<a href="https://chatgpt.cn.obiscr.com/blog/posts/2023/How-to-get-api-key/#api-key">https://chatgpt.cn.obiscr.com/blog/posts/2023/How-to-get-api-key/#api-key</a><br>
工程化工具：<a href="https://python.langchain.com/en/latest/getting_started/getting_started.html#">https://python.langchain.com/en/latest/getting_started/getting_started.html#</a><br>
visual chatgpt：<a href="https://github.com/microsoft/visual-chatgpt">https://github.com/microsoft/visual-chatgpt</a></p>
</blockquote>
<p>本地试了下visual chatgpt，对于VQA依赖前置VFM对图像的理解，稍微复杂的场景就不可用了。感觉整体还是偏向于简单任务处理图像。本地M1搭了一下也可以使用，只不过比较慢，下面是几个实例：</p>
<center><img src="/images/Pasted%20image%2020230326201405.png" width="75%" height="75%" /></center>
<p>模型对于图像的理解：</p>
<pre tabindex="0"><code>Human: provide a figure named image/0afb204f.png. The description is: a man in a room with a tv and a television. This information helps you to understand this image, but you should use tools to finish following tasks, rather than directly imagine from my description. If you understand, say &#34;Received&#34;. 
AI: Received. 
</code></pre><p>chatgpt的回答是基于以上的description。</p>
<center><img src="/images/Pasted%20image%2020230326201933.png" width="75%" height="75%" /></center>
<p>理解：</p>
<pre tabindex="0"><code>AI: The image contains a man in a room with a tv and a television. The woman in the image is standing.
Human: provide a figure named image/a467ee40.png. The description is: a screenshote of a chinese food. This information helps you to understand this image, but you should use tools to finish following tasks, rather than directly imagine from my description. If you understand, say &#34;Received&#34;. 
AI: Received.  
</code></pre>

	</div>
	
      </div>
	  	<div class="disqus markdown">
		<div id="disqus_thread"></div>
<script type="text/javascript">

(function() {
    
    
    
    

    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    var disqus_shortname = 'rainpot';
    dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

		</div>
      <div class="container">
  <span class="row justify-content-center meta" id="footer">
    Copyright ©
      2024
    RainPot
  </span>
  <script defer src="/js/custom.js"></script>
  

</div>

    </div>
  </div>
</div>

  </body>

</html>
